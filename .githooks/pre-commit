#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Starting checks..."

run_with_powershell() {
  local cmd="$1"
  powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "$cmd"
}

has_powershell=false
if command -v powershell.exe >/dev/null 2>&1; then
  has_powershell=true
fi

echo "[pre-commit] Running JuliaFormatter (CI-mode temp env)..."
if $has_powershell; then
  run_with_powershell "julia --project=. scripts/format_ci.jl"
else
  julia --project=. scripts/format_ci.jl
fi

# Stage any formatting changes
if ! git diff --quiet; then
  echo "[pre-commit] Formatting changes applied; staging updates."
  git add -A
fi

echo "[pre-commit] Running Julia tests..."
if $has_powershell; then
  run_with_powershell "julia --project=. -e \"using Pkg; Pkg.instantiate(); Pkg.test()\""
else
  julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.test()'
fi

echo "[pre-commit] Done."
