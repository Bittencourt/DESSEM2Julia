name: Copilot Agent Runner

on:
  push:
    branches:
      - 'feat/agent-*/**'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  run-agent:
    name: ü§ñ Agent Runner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Instructions
        id: check_instructions
        run: |
          if [ -f INSTRUCTIONS.md ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice title=Instructions Found::Found INSTRUCTIONS.md for Agent"
            cat INSTRUCTIONS.md
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning title=Missing Instructions::No INSTRUCTIONS.md found in root"
          fi

      - name: Execute Agent Task
        if: steps.check_instructions.outputs.exists == 'true'
        run: |
          echo "üöÄ Deploying Copilot Agent for branch ${{ github.ref_name }}"
          echo "üìã Task: Follow INSTRUCTIONS.md"
          echo "----------------------------------------"
          cat INSTRUCTIONS.md
          echo "----------------------------------------"
          echo "Agent is analyzing the task..."
          # Placeholder for actual agent invocation
          # e.g., gh copilot run "Implement the parser described in INSTRUCTIONS.md"

      - name: Create Pull Request
        if: steps.check_instructions.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Creating Pull Request..."
          gh pr create \
            --title "feat: Implement parser for ${{ github.ref_name }}" \
            --body "Automated PR for parser implementation based on INSTRUCTIONS.md." \
            --base main \
            --head ${{ github.ref_name }} \
            || echo "‚ö†Ô∏è PR already exists or failed to create (check logs)"
