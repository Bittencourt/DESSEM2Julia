---
phase: 02-test-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/termdat_tests.jl
autonomous: true

must_haves:
  truths:
    - "CADUNIDT min > capacity test is uncommented and passes"
    - "CURVACOMB zero heat_rate test is uncommented and passes"
    - "CURVACOMB negative generation test is uncommented and passes"
    - "Tests that cannot pass are documented with clear TODO comments"
  artifacts:
    - path: "test/termdat_tests.jl"
      provides: "Uncommented validation tests"
      contains: "@test_throws ParserError"
  key_links:
    - from: "Validation tests"
      to: "ParserError validation"
      via: "@test_throws ParserError"
      pattern: "parse_cadunidt.*parse_curvacomb"
---

<objective>
Uncomment tests that now pass after Phase 1 error handling fixes, and document those that cannot pass.

Purpose: DEBT-07 - Resolve commented-out tests (fix or document).
Output: termdat_tests.jl with passing tests uncommented, failing tests documented.

**Analysis of Commented Tests:**

| Test | Line | Status | Action |
|------|------|--------|--------|
| CADUSIT Extended Format | 64 | Column overlap, no real examples | Keep commented, improve TODO |
| CADUNIDT min > capacity | 169 | ✅ Fixed in Phase 1 | Uncomment |
| CURVACOMB zero heat_rate | 226 | ✅ Works | Uncomment |
| CURVACOMB negative heat_rate | 232 | ❌ Parser bug (sign not in field) | Keep commented, document bug |
| CURVACOMB negative generation | 238 | ✅ Works | Uncomment |
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 Fixed These Issues:
# - ParserError argument order corrected
# - Validation helpers now include file/line context
# - validate_positive, validate_nonnegative, validate_range all throw ParserError

# Known Remaining Bug:
# CURVACOMB heat_rate field (columns 19-23) doesn't include sign character
# Negative values parse as positive because "-" is at column 18
# This is a parser bug that requires FieldSpec adjustment (separate fix)
</context>

<tasks>

<task type="auto">
  <name>Uncomment CADUNIDT min > capacity test</name>
  <files>test/termdat_tests.jl</files>
  <action>
Find and uncomment the CADUNIDT validation test at line 169:

Before:
```julia
# TODO: Fix validation error handling - currently throws MethodError instead of ParserError
# @test_throws ParserError parse_cadunidt(
#     "CADUNIDT   1  1 2025 04 26 00 0     100.000    150.000     0     0",
#     "test.dat", 1
# )
```

After:
```julia
# Fixed in Phase 1: ParserError now thrown correctly
@test_throws ParserError parse_cadunidt(
    "CADUNIDT   1  1 2025 04 26 00 0     100.000    150.000     0     0",
    "test.dat",
    1,
)
```
  </action>
  <verify>grep -A3 "min_generation > capacity" test/termdat_tests.jl | grep -v "^#"</verify>
  <done>CADUNIDT min > capacity test uncommented</done>
</task>

<task type="auto">
  <name>Uncomment passing CURVACOMB tests</name>
  <files>test/termdat_tests.jl</files>
  <action>
Uncomment the CURVACOMB validation tests that now pass:

1. Zero heat_rate (line ~226):
```julia
# Invalid heat rate (zero) - validated by validate_positive
@test_throws ParserError parse_curvacomb(
    "CURVACOMB   1  1     0    350.000",
    "test.dat",
    1,
)
```

2. Negative generation (line ~238):
```julia
# Invalid generation (negative) - validated by validate_nonnegative
@test_throws ParserError parse_curvacomb(
    "CURVACOMB   1  1  9500   -100.000",
    "test.dat",
    1,
)
```
  </action>
  <verify>grep -c "@test_throws ParserError parse_curvacomb" test/termdat_tests.jl returns at least 2</verify>
  <done>Passing CURVACOMB tests uncommented</done>
</task>

<task type="auto">
  <name>Document CURVACOMB negative heat_rate bug</name>
  <files>test/termdat_tests.jl</files>
  <action>
Update the TODO comment for the negative heat_rate test with clear documentation:

```julia
# PARSER BUG: Negative heat_rate not detected
# FieldSpec for heat_rate uses columns 19-23, but the "-" sign is at column 18
# Result: "-1000" parses as "1000" (sign lost)
# TODO: Adjust FieldSpec to include sign character, or use parse(Int, strip(s))
# Tracked as: https://github.com/Bittencourt/DESSEM2Julia/issues/XXX
# @test_throws ParserError parse_curvacomb(
#     "CURVACOMB   1  1 -1000    350.000",
#     "test.dat", 1
# )
```

This documents the bug for future fixing without breaking CI.
  </action>
  <verify>grep "PARSER BUG.*Negative heat_rate" test/termdat_tests.jl</verify>
  <done>CURVACOMB bug documented with clear TODO</done>
</task>

<task type="auto">
  <name>Improve CADUSIT Extended Format TODO</name>
  <files>test/termdat_tests.jl</files>
  <action>
Update the CADUSIT Extended Format test comment with clearer documentation:

```julia
# MISSING SAMPLE DATA: Extended CADUSIT format with heat_rate and fuel_cost
# Current parser has column overlap issues for these optional fields.
# Test commented until we have real DESSEM files with this format.
# See: TERMDAT documentation for extended format specification
# @testset "CADUSIT - Extended Format with Optional Fields" begin
#     ...
# end
```
  </action>
  <verify>grep "MISSING SAMPLE DATA.*Extended CADUSIT" test/termdat_tests.jl</verify>
  <done>CADUSIT extended format TODO improved</done>
</task>

<task type="auto">
  <name>Run tests to verify all changes</name>
  <files>test/termdat_tests.jl</files>
  <action>
Run the test suite to verify all uncommented tests pass:

```bash
julia --project -e 'using Pkg; Pkg.test()'
```

All tests should pass. If any fail, investigate and fix.
  </action>
  <verify>julia --project -e 'using Pkg; Pkg.test()' exits with code 0</verify>
  <done>All tests pass after uncommenting</done>
</task>

</tasks>

<verification>
1. Run `julia --project -e 'using Pkg; Pkg.test()'` - all tests pass
2. Count uncommented @test_throws ParserError in termdat_tests.jl - should be 5+
3. All TODO comments clearly explain why tests are commented
</verification>

<success_criteria>
- CADUNIDT min > capacity test passes
- CURVACOMB zero heat_rate test passes
- CURVACOMB negative generation test passes
- CURVACOMB negative heat_rate bug documented
- CADUSIT extended format documented
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-test-infrastructure/02-02-SUMMARY.md`
</output>
