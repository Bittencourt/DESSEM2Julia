---
phase: 01-error-handling-foundation
plan: 05
type: gap_closure
wave: 1
depends_on: []
files_modified:
  - src/parser/entdados.jl
  - test/parser/entdados_tests.jl
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "R## records parse without warning about unknown record type"
    - "R## record data is accessible in parsed EntdadosData structure"
    - "CR records define polynomial coefficients for R## records"
  artifacts:
    - path: "src/parser/entdados.jl"
      provides: "R## record parsing for reservoir elevation limits"
      contains: "record_type == \"R\""
    - path: "test/parser/entdados_tests.jl"
      provides: "Tests for R## record parsing"
      contains: "R11"
  key_links:
    - from: "R## records in entdados.dat"
      to: "CR records (polynomial definitions)"
      via: "Record name matching (R11 â†’ CR index 1)"
      pattern: "R[0-9]+"
---

<objective>
Add parsing support for R## (reservoir elevation) records in entdados.dat to eliminate unknown record type warnings.

Purpose: Complete parser coverage for ONS network-enabled cases that include reservoir elevation constraints.
Output: entdados.jl with R## record parsing + tests.

**Gap Source:** UAT testing revealed "Unknown record type in entdados.dat line 5398: R" warning when parsing ONS sample data.

**Background:**
- R## records define reservoir elevation constraints (cota inicial, var.hora, var.dia)
- CR records define polynomial coefficients for converting elevation to volume
- Example from ONS sample:
  ```
  CR    1           R11    6   7.6677112E+01   2.8660334E-03  ...
  R11 11  0 0  F           94.74      0.50      2.85
  ```
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# R## Record Format (from ONS sample)
# &   Registro R11
# &   di hi m df hf m    cotaIni  var.hora   var.dia
# &X  XX XX X XX XX X XXXXXXXXXXxxxxxxxxxxXXXXXXXXXX
# R11 11  0 0  F           94.74      0.50      2.85
#
# Fields:
# - Record type: R## (e.g., R11, R12, etc.)
# - Stage references (di, hi, m, df, hf, m): Date/time range
# - Flag: F or other constraint flag
# - cotaIni: Initial elevation (m)
# - var.hora: Hourly variation rate
# - var.dia: Daily variation rate

# CR Record Format (polynomial coefficients)
# CR    1           R11    6   7.6677112E+01   2.8660334E-03  -1.0474654E-07  ...
# - Index, Name, Polynomial order, Coefficients...
</context>

<tasks>

<task type="auto">
  <name>Research R## record format in idessem/inewave</name>
  <files>docs/research/R_records.md</files>
  <action>
1. Check idessem repository for R## record parsing implementation
2. Check inewave repository for equivalent NEWAVE records
3. Document the exact field positions and types
4. Identify how CR records link to R## records

If reference implementations don't have R## records:
- Analyze sample data directly to determine field positions
- Document findings for future reference
  </action>
  <verify>docs/research/R_records.md exists with format specification</verify>
  <done>R## record format documented</done>
</task>

<task type="auto">
  <name>Add R## record type detection in entdados.jl</name>
  <files>src/parser/entdados.jl</files>
  <action>
Update the record type detection logic to handle R## records:

1. Find the record type dispatch section (around line 1595-1631)
2. Add detection for R## pattern:
```julia
elseif match(r"^R\d+$", record_type) !== nothing
    # R## record - reservoir elevation constraints
    # parse_r_record!(...)
```

3. Create a parsing function or inline the logic:
```julia
function parse_r_record!(data::EntdadosData, line::AbstractString, filename::String, line_num::Int)
    # Extract record name (R11, R12, etc.)
    # Parse di, hi, m, df, hf, m (date range)
    # Parse flag
    # Parse cotaIni, var.hora, var.dia
    # Store in data.reservoir_elevations or similar structure
end
```

CRITICAL: Use ParserError for all validation failures with proper file/line context.
  </action>
  <verify>
grep -n "R\\\\d+" src/parser/entdados.jl
# Run parser on ONS sample - no unknown record type warning for R11
  </verify>
  <done>R## records parsed without warnings</done>
</task>

<task type="auto">
  <name>Add R## record data structure</name>
  <files>src/models/core_types.jl, src/parser/entdados.jl</files>
  <action>
1. Define ReservoirElevation struct in core_types.jl:
```julia
struct ReservoirElevation
    name::String                    # R11, R12, etc.
    stage_start::Int                # di (initial day)
    hour_start::Int                 # hi (initial hour)
    month_start::Int                # m (initial month)
    stage_end::Int                  # df (final day)
    hour_end::Int                   # hf (final hour)
    month_end::Int                  # m (final month)
    flag::String                    # Constraint flag
    initial_elevation::Float64      # cotaIni (meters)
    hourly_variation::Float64       # var.hora (m/hour)
    daily_variation::Float64        # var.dia (m/day)
end
```

2. Add to EntdadosData struct:
```julia
reservoir_elevations::Vector{ReservoirElevation} = ReservoirElevation[]
```

3. Ensure ParserError is thrown for validation failures.
  </action>
  <verify>
grep -n "ReservoirElevation" src/models/core_types.jl
grep -n "reservoir_elevations" src/parser/entdados.jl
  </verify>
  <done>Data structure defined and integrated</done>
</task>

<task type="auto">
  <name>Add tests for R## record parsing</name>
  <files>test/parser/entdados_tests.jl</files>
  <action>
Add test cases for R## record parsing:

```julia
@testset "R## Record Parsing" begin
    @testset "R11 record parses correctly" begin
        line = "R11 11  0 0  F           94.74      0.50      2.85"
        # Test parsing logic
    end
    
    @testset "Multiple R## records" begin
        # Test with sample data containing multiple R records
    end
    
    @testset "No unknown record warnings for R##" begin
        # Verify no @warn for R## types
    end
end
```
  </action>
  <verify>julia --project -e 'using Pkg; Pkg.test()' includes R## tests</verify>
  <done>R## record tests pass</done>
</task>

</tasks>

<verification>
1. Run `julia --project examples/verify_ons_compatibility.jl` - no unknown record type warnings
2. Run test suite - all tests pass
3. Parse ONS sample data - verify reservoir_elevations populated
</verification>

<success_criteria>
- No "Unknown record type: R" warnings when parsing ONS sample
- R## record data accessible in EntdadosData.reservoir_elevations
- Tests pass for R## record parsing
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-handling-foundation/01-05-SUMMARY.md`
</output>
